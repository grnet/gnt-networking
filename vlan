#!/bin/sh
#

add_vlan() {
	if [ -n "`echo -n "$1" | tr -d '[0-9]'`" ]; then
		echo "Invalid vlan tag $1"
		exit 1
	fi
		
	vlan=$1
	ifce=$2

	if [ -d "/sys/class/net/vlan${vlan}/bridge" ]; then
		echo "Vlan $vlan already configured"
		exit 0
	fi

	if ( grep -q "iface vlan${vlan}$" /etc/network/interfaces ); then
		echo "Vlan $vlan configured but down, bringing up"
	else
		echo "Adding vlan $vlan to /etc/network/interfaces"
		cat >>/etc/network/interfaces <<EOF
auto vlan${vlan}
iface vlan${vlan} inet manual
	bridge_ports	${ifce}.${vlan}
	bridge_stp	off
	bridge_maxwait	0
	bridge_fd	0

EOF
	fi

	/sbin/ifup "vlan${vlan}" >/dev/null 2>&1
	exit 0
}

list_vlans() {
	for iface in /sys/class/net/vlan*; do
		if [ -d "$iface/bridge" ]; then
			vlan=`basename "$iface"`
			( grep -q "iface $vlan" /etc/network/interfaces )
			if [ $? -eq 0 ]; then
				echo "${vlan##vlan}"
			else
				echo "${vlan##vlan} (unconfigured)"
			fi
		fi
	done

}

remove_vlan() {
	if [ -n "`echo -n "$1" | tr -d '[0-9]'`" ]; then
		echo "Invalid vlan tag $1"
		exit 1
	fi

	vlan=$1

    # Bring interface down (does vconfig rem as well)
	ifdown vlan$vlan
	if [ $? -eq 0 ]; then
		echo "Interface Vlan $vlan successfully down"
	else
		echo "Problem removing Interface Vlan ${vlan##vlan} "
		exit 1
	fi

	# Remove config part of /etc/network/interfaces 
	# NUMBER OF LINES to delete depends on add_vlan function
	sed -i -e "/auto vlan${vlan##vlan}$/,+6d" /etc/network/interfaces
	if [ $? -eq 0 ]; then
		echo "Vlan $vlan removed from /etc/network/interfaces"
	fi

	if [ -d "/sys/class/net/vlan${vlan##vlan}/bridge" ]; then
		echo "Vlan ${vlan##vlan} still configured"
		exit 1
	else
		exit 0
	fi
	
}

case "$1" in
	add)
	if [ x"$3" != x"" ]; then
		ifce=$3
	else
		ifce="bond0"
	fi
	add_vlan "$2" "$ifce"
	;;
	remove)
	remove_vlan "$2"
	;;
	list)
	list_vlans
	;;
	*)
	echo "Usage: vlan (add number [ifce="bond0"]|remove number|list)"
	;;
esac;

